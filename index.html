<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇宙人発見伝</title>
    <style>
        body {
            background-color: #00b4d4;
            margin: 0;
            padding: 0;
            color: white;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        h1 {
            text-align: center;
        }

        #completedStamps {
            text-align: center;
            font-size: 18px;
        }

        #gameStartPopup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .popup-content {
            position: relative;
            max-width: 100%;
            height: 100%;
            background: url('Top-Img.png') center center / cover no-repeat;
            text-align: center;
        }

        .overlay-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 20px;
            color: #5f5f5f;
            font-size: 1rem;
        }

        .Btytle {
            width: 80%;
        }

        .overlay-content button {
            background-color: #12335f;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .overlay-content button:hover {
            background-color: #fff;
        }

        .Stytle {
            width: 20%;
            padding: 10px;
            position: absolute;
            top: 0;
            left: 0;
        }

        #lastUpdateTime {
            text-align: center;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>

<body>
    <h1><img class="Stytle" src="invader-hunt@2x.png" alt="Description of the image"></h1>
    <div id="completedStamps"></div>
    <div id="lastUpdateTime"></div>

    <!-- ゲーム開始の確認ポップアップ -->
    <div id="gameStartPopup" style="display: block;">
        <div class="popup-content">
            <!-- その上に他の要素 -->
            <div class="overlay-content">
                <img class="Btytle" src="invader-hunt@2x.png" alt="Description of the image">
                <p>ゲームを始めますか？</p>
                <button onclick="startGame()">OK</button>
            </div>
        </div>
    </div>

    <!-- ゲームのスクリプト -->
    <script>
        // ゲームの開始状態
        let gameStarted = false;

        // スタンプの位置情報
        const stampLocations = [
            { lat: 35.6152, lng: 139.3349 }, // 東京造形大学1号館
            { lat: 35.6157, lng: 139.3333 }, // 東京造形大学7号館
            { lat: 35.6167, lng: 139.3334 }  // 東京造形大学10号館
            // 必要に応じて他の位置を追加
            // 小数第4位を誤差する(0.0001ずれる)と10mの誤差(経度、緯度両方で14m)になる。
            // よって少数第4位までは確実に記載する
        ];

        // スタンプの履歴
        const stampedHistory = [];

        // 手掛かり1, 2, 3の取得状態
        let hasClue1 = false;
        let hasClue2 = false;
        let hasClue3 = false;

        // ダイアログの表示間隔（ミリ秒）
        const dialogInterval = 10000; // 10秒

        // 最後にダイアログを表示した時刻
        let lastDialogTime = 0;

        // 最後に位置情報を取得した時刻
        let lastUpdateTime = 0;

        // ゲーム開始関数
        function startGame() {
            document.getElementById('gameStartPopup').style.display = 'none';
            gameStarted = true;
            updateUserLocation();
        }

        // ユーザーの位置情報を更新する関数
        function updateUserLocation() {
            // ゲームが開始されている場合のみ位置情報を更新
            if (navigator.geolocation && gameStarted) {
                setInterval(() => {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            // ユーザーの位置情報
                            const userLocation = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                            };

                            // ダイアログ表示の制御
                            const currentTime = new Date().getTime();
                            if (currentTime - lastDialogTime >= dialogInterval) {
                                // 範囲内外の表示
                                if (isInsideArea(userLocation)) {
                                    if (hasClue1 && hasClue2 && hasClue3) {
                                        document.getElementById('completedStamps').innerHTML = '<h2>東京造形大学編</h2>';
                                    } else {
                                        document.getElementById('completedStamps').innerHTML = '<p>探索中です</p>';
                                    }

                                    // ユーザーがスタンプの近くにいるか確認
                                    let stamped = false;
                                    let hasClue123 = hasClue1 && hasClue2 && hasClue3;
                                    stampLocations.forEach(location => {
                                        const distance = calculateDistance(userLocation, location);
                                        const locationKey = `${location.lat.toFixed(4)}-${location.lng.toFixed(4)}`;

                                        // ユーザーがスタンプの近くにいて、スタンプの位置との距離が50m未満であるかの判定
                                        if (distance < 50 && !stamped && (hasClue123 || locationKey === '35.6068-139.3319')) {
                                            alert('Stamped!');
                                            stamped = true;

                                            // スタンプが完了した場所の位置情報を履歴に追加
                                            stampedHistory.push(locationKey);

                                            // 手掛かり1, 2, 3の取得状態を更新
                                            if (locationKey === '35.6152-139.3349') {
                                                hasClue1 = true;
                                            } else if (locationKey === '35.6157-139.3333') {
                                                hasClue2 = true;
                                            } else if (locationKey === '35.6167-139.3334') {
                                                hasClue3 = true;
                                            }

                                            // 履歴を表示
                                            const stampedInfo = `Location: Lat ${location.lat}, Lng ${location.lng}`;
                                            document.getElementById('completedStamps').innerHTML += `<p>${stampedInfo}</p>`;

                                            // 表示する手掛かりの情報
                                            displayClueInfo(location);

                                            // ダイアログを表示した時刻を更新
                                            lastDialogTime = currentTime;
                                        }
                                    });
                                } else {
                                    document.getElementById('completedStamps').innerHTML = '<p>探索範囲外です</p>';
                                }
                            }

                            // 最後に位置情報を取得した時刻を更新
                            lastUpdateTime = currentTime;
                            updateLastUpdateTime();
                        },
                        error => {
                            console.error('Error getting user location:', error);
                        }
                    );
                }, 5000); // 5秒ごとに位置情報を取得
            } else {
                console.error('Geolocation is not supported by this browser or the game has not started yet.');
            }
        }

        // 2つの地点間の距離を計算する関数
        function calculateDistance(point1, point2) {
            const R = 6371e3; // 地球の半径（メートル）
            const lat1 = toRadians(point1.lat);
            const lat2 = toRadians(point2.lat);
            const deltaLat = toRadians(point2.lat - point1.lat);
            const deltaLng = toRadians(point2.lng - point1.lng);

            const a = Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +
                Math.cos(lat1) * Math.cos(lat2) *
                Math.sin(deltaLng / 2) * Math.sin(deltaLng / 2);

            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            const distance = R * c;
            return distance;
        }

        // 度をラジアンに変換する関数
        function toRadians(degrees) {
            return degrees * (Math.PI / 180);
        }

        // 探索エリア内外の判定
        function isInsideArea(userLocation) {
            // 指定された範囲内かどうかを判定
            const insideArea = (
                userLocation.lat >= 35.6058 && userLocation.lat <= 35.6184 &&
                userLocation.lng >= 139.3314 && userLocation.lng <= 139.3359
            );

            // 条件に応じて表示を変更
            document.getElementById('completedStamps').innerHTML = insideArea ? '<h2>東京造形大学編</h2>' : '<p>探索範囲外です</p>';

            return insideArea;
        }

        // 表示する手掛かりの情報
        function displayClueInfo(location) {
            const clues = {
                '35.6152-139.3349': '手掛かり1',
                '35.6157-139.3333': '手掛かり2',
                '35.6167-139.3334': '手掛かり3',
                '35.6068-139.3319': '手掛かり4',
            };

            const locationKey = `${location.lat.toFixed(4)}-${location.lng.toFixed(4)}`;
            const clueInfo = clues[locationKey];

            if (clueInfo) {
                document.getElementById('completedStamps').innerHTML += `<p>${clueInfo}</p>`;
            }
        }

        // 最後に位置情報を取得した時刻を表示する関数
        function updateLastUpdateTime() {
            const lastUpdateElement = document.getElementById('lastUpdateTime');
            const lastUpdateDate = new Date(lastUpdateTime);
            const formattedTime = lastUpdateDate.toLocaleTimeString();
            lastUpdateElement.innerHTML = `最後の位置情報取得時刻: ${formattedTime}`;
        }

        // ページ読み込み時に確認ポップアップを表示
        window.onload = function () {
            document.getElementById('gameStartPopup').style.display = 'block';
        };
    </script>
</body>

</html>
